<!--
Copyright 2017 Next Century Corporation

Licensed under the Apache License, Version 2.0 (the "License");
you may not use this file except in compliance with the License.
You may obtain a copy of the License at

    http://www.apache.org/licenses/LICENSE-2.0

Unless required by applicable law or agreed to in writing, software
distributed under the License is distributed on an "AS IS" BASIS,
WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
See the License for the specific language governing permissions and
limitations under the License.
-->

<html>
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, minimum-scale=1.0, initial-scale=1.0, user-scalable=yes">
  <script src="../../webcomponentsjs/webcomponents-lite.js"></script>
  <script src="../../web-component-tester/browser.js"></script>
  <link rel="import" href="../extraction-grid.html">
</head>

<body>
  <test-fixture id="extraction-grid-fixture">
    <template>
      <extraction-grid></extraction-grid>
    </template>
  </test-fixture>

  <script>
    suite('extraction-grid tests', function() {
      var element;

      setup(function(done) {
        element = fixture('extraction-grid-fixture');
        element.extractions = [{
          name: 'name1',
          data: []
        }, {
          name: 'name2',
          data: [{
            text: 'text2'
          }]
        }, {
          name: 'name3',
          data: [{
            icon: 'icon',
            styleClass: 'styleClass',
            text: 'text3'
          }, {
            link: 'link',
            text: 'text4'
          }]
        }, {
          name: 'name4',
          data: [{
            confidence: 100,
            text: 'text5'
          }, {
            confidence: 50,
            provenances: [{
              method: 'provenanceMethod1',
              text: 'provenanceText1'
            }],
            text: 'text6'
          }]
        }];
        element.resultId = 'abcd1234';
        flush(done);
      });

      test('properties are set as expected', function() {
        expect(element.dataProperty).to.equal('data');
        expect(element.dataClassificationsProperty).to.equal('classifications');
        expect(element.dataConfidenceProperty).to.equal('confidence');
        expect(element.dataHighlightProperty).to.equal('highlight');
        expect(element.dataIconProperty).to.equal('icon');
        expect(element.dataIdProperty).to.equal('id');
        expect(element.dataLinkProperty).to.equal('link');
        expect(element.dataProvenancesProperty).to.equal('provenances');
        expect(element.dataStyleClassProperty).to.equal('styleClass');
        expect(element.dataTextProperty).to.equal('text');
        expect(element.nameProperty).to.equal('name');
        expect(element.provenanceMethodProperty).to.equal('method');
        expect(element.provenanceTextProperty).to.equal('text');
        expect(element.resultId).to.equal('abcd1234');
        expect(element.tagManager).to.not.exist;
        expect(element.target).to.equal('_self');
      });

      test('extractions are set as expected', function() {
        expect(element.extractions).to.deep.equal([{
          name: 'name1',
          data: []
        }, {
          name: 'name2',
          data: [{
            text: 'text2'
          }]
        }, {
          name: 'name3',
          data: [{
            icon: 'icon',
            styleClass: 'styleClass',
            text: 'text3'
          }, {
            link: 'link',
            text: 'text4'
          }]
        }, {
          name: 'name4',
          data: [{
            confidence: 100,
            text: 'text5'
          }, {
            confidence: 50,
            provenances: [{
              method: 'provenanceMethod1',
              text: 'provenanceText1'
            }],
            text: 'text6'
          }]
        }]);
      });

      test('does show an extraction-list element', function() {
        expect(element.$$('.extraction-list')).to.exist;
      });

      test('does show extraction elements', function() {
        var extractions = Polymer.dom(element.root).querySelectorAll('.extraction');
        expect(extractions).to.exist;
        expect(extractions.length).to.equal(3);
      });

      test('does show extraction-name elements', function() {
        var names = Polymer.dom(element.root).querySelectorAll('.extraction-name');
        expect(names).to.exist;
        expect(names.length).to.equal(3);
        expect(names[0].innerHTML).to.equal('name2');
        expect(names[1].innerHTML).to.equal('name3');
        expect(names[2].innerHTML).to.equal('name4');
      });

      test('does show extraction-item elements', function() {
        var items = Polymer.dom(element.root).querySelectorAll('.extraction-item');
        expect(items).to.exist;
        expect(items.length).to.equal(5);
      });

      test('does show confidence-marker elements', function() {
        var markers = Polymer.dom(element.root).querySelectorAll('confidence-marker');
        expect(markers).to.exist;
        expect(markers.length).to.equal(5);
        expect(markers[0].confidence).to.not.exist;
        expect(markers[0].documentId).to.equal('abcd1234');
        expect(markers[0].provenanceMethodProperty).to.equal('method');
        expect(markers[0].provenanceTextProperty).to.equal('text');
        expect(markers[0].provenances).to.not.exist;
        expect(markers[1].confidence).to.not.exist;
        expect(markers[1].documentId).to.equal('abcd1234');
        expect(markers[1].provenanceMethodProperty).to.equal('method');
        expect(markers[1].provenanceTextProperty).to.equal('text');
        expect(markers[1].provenances).to.not.exist;
        expect(markers[2].confidence).to.not.exist;
        expect(markers[2].documentId).to.equal('abcd1234');
        expect(markers[2].provenanceMethodProperty).to.equal('method');
        expect(markers[2].provenanceTextProperty).to.equal('text');
        expect(markers[2].provenances).to.not.exist;
        expect(markers[3].confidence).to.equal(100);
        expect(markers[3].documentId).to.equal('abcd1234');
        expect(markers[3].provenanceMethodProperty).to.equal('method');
        expect(markers[3].provenanceTextProperty).to.equal('text');
        expect(markers[3].provenances).to.not.exist;
        expect(markers[4].confidence).to.equal(50);
        expect(markers[4].documentId).to.equal('abcd1234');
        expect(markers[4].provenanceMethodProperty).to.equal('method');
        expect(markers[4].provenanceTextProperty).to.equal('text');
        expect(markers[4].provenances).to.deep.equal([{
          method: 'provenanceMethod1',
          text: 'provenanceText1'
        }]);
      });

      test('does not show tag-extraction-buttons elements if tagManager is undefined', function() {
        expect(element.$$('tag-extraction-buttons')).to.not.exist;
      });

      test('_getConfidenceStyleClass does return as expected', function() {
        expect(element._getConfidenceStyleClass).to.be.a('Function');
        expect(element._getConfidenceStyleClass({}, 'confidence')).to.equal('hide');
        expect(element._getConfidenceStyleClass({
          notconfidence: 'high'
        }, 'confidence')).to.equal('hide');
        expect(element._getConfidenceStyleClass({
          confidence: 'high'
        }, 'notconfidence')).to.equal('hide');
        expect(element._getConfidenceStyleClass({
          confidence: 'unsupported'
        }, 'confidence')).to.equal('hide');
        expect(element._getConfidenceStyleClass({
          confidence: 'high'
        }, 'confidence')).to.equal('high-confidence');
        expect(element._getConfidenceStyleClass({
          confidence: 'low'
        }, 'confidence')).to.equal('low-confidence');
      });

      test('_getConfidenceText does return as expected', function() {
        expect(element._getConfidenceText).to.be.a('Function');
        expect(element._getConfidenceText({}, 'confidence')).to.equal('');
        expect(element._getConfidenceText({
          notconfidence: 'high'
        }, 'confidence')).to.equal('');
        expect(element._getConfidenceText({
          confidence: 'high'
        }, 'notconfidence')).to.equal('');
        expect(element._getConfidenceText({
          confidence: 'unsupported'
        }, 'confidence')).to.equal('');
        expect(element._getConfidenceText({
          confidence: 'high'
        }, 'confidence')).to.equal('High Confidence Extraction');
        expect(element._getConfidenceText({
          confidence: 'low'
        }, 'confidence')).to.equal('Low Confidence Extraction');
      });

      test('_getHighlightableLabelStyleClass does return as expected', function() {
        expect(element._getHighlightableLabelStyleClass).to.be.a('Function');
        expect(element._getHighlightableLabelStyleClass({}, 'highlight')).to.equal('');
        expect(element._getHighlightableLabelStyleClass({
          nothighlight: true
        }, 'highlight')).to.equal('');
        expect(element._getHighlightableLabelStyleClass({
          highlight: true
        }, 'nothighlight')).to.equal('');
        expect(element._getHighlightableLabelStyleClass({
          highlight: false
        }, 'highlight')).to.equal('');
        expect(element._getHighlightableLabelStyleClass({
          highlight: 0
        }, 'highlight')).to.equal('');
        expect(element._getHighlightableLabelStyleClass({
          highlight: true
        }, 'highlight')).to.equal('highlight');
        expect(element._getHighlightableLabelStyleClass({
          highlight: 1
        }, 'highlight')).to.equal('highlight');
        expect(element._getHighlightableLabelStyleClass({
          highlight: 'string'
        }, 'highlight')).to.equal('highlight');
      });

      test('_getLength does return as expected', function() {
        expect(element._getLength).to.be.a('Function');
        expect(element._getLength({}, 'list')).to.not.exist;
        expect(element._getLength({
          list: []
        }, 'notlist')).to.not.exist;
        expect(element._getLength({
          notlist: []
        }, 'list')).to.not.exist;
        expect(element._getLength({
          list: []
        }, 'list')).to.equal(0);
        expect(element._getLength({
          list: [1]
        }, 'list')).to.equal(1);
        expect(element._getLength({
          list: [1, 2]
        }, 'list')).to.equal(2);
      });

      test('_getList does return as expected', function() {
        expect(element._getList).to.be.a('Function');
        expect(element._getList({}, 'list')).to.deep.equal([]);
        expect(element._getList({
          list: []
        }, 'notlist')).to.deep.equal([]);
        expect(element._getList({
          notlist: []
        }, 'list')).to.deep.equal([]);
        expect(element._getList({
          list: []
        }, 'list')).to.deep.equal([]);
        expect(element._getList({
          list: [1]
        }, 'list')).to.deep.equal([1]);
        expect(element._getList({
          list: [1, 2]
        }, 'list')).to.deep.equal([1, 2]);
      });

      test('_getProperty does return as expected', function() {
        expect(element._getProperty).to.be.a('Function');
        expect(element._getProperty({}, 'property')).to.not.exist;
        expect(element._getProperty({
          property: 'text'
        }, 'notproperty')).to.not.exist;
        expect(element._getProperty({
          notproperty: 'text'
        }, 'property')).to.not.exist;
        expect(element._getProperty({
          property: 'text'
        }, 'property')).to.equal('text');
        expect(element._getProperty({
          property: 10
        }, 'property')).to.equal(10);
        expect(element._getProperty({
          property: true
        }, 'property')).to.be.true;
        expect(element._getProperty({
          property: [1, 2, 3, 4, 5]
        }, 'property')).to.deep.equal([1, 2, 3, 4, 5]);
        expect(element._getProperty({
          property: {
            key: 'value'
          }
        }, 'property')).to.deep.equal({
          key: 'value'
        });
      });
    });

    suite('extraction-grid tests with no extractions', function() {
      var element;

      setup(function(done) {
        element = fixture('extraction-grid-fixture');
        flush(done);
      });

      test('extractions are set as expected', function() {
        expect(element.extractions).to.deep.equal([]);
      });

      test('does not show extraction elements if extractions is undefined', function() {
        expect(element.$$('.extraction')).to.not.exist;
        expect(element.$$('.extraction-name')).to.not.exist;
        expect(element.$$('.extraction-item')).to.not.exist;
        expect(element.$$('confidence-marker')).to.not.exist;
        expect(element.$$('tag-extraction-buttons')).to.not.exist;
      });
    });

    suite('extraction-grid tests with tagManager', function() {
      var element;

      setup(function(done) {
        element = fixture('extraction-grid-fixture');
        element.extractions = [{
          name: 'name1',
          data: [{
            id: 'id1',
            text: 'text1'
          }]
        }, {
          name: 'name2',
          data: [{
            classifications: {
              database: 'negative',
              type: 'type2',
              user: 'positive'
            },
            id: 'id2',
            text: 'text2'
          }]
        }];
        element.resultId = 'abcd1234';
        element.tagManager = {
          addListener: function() {},
          removeListener: function() {},
          setExtractionTag: function() {}
        };
        flush(done);
      });

      test('extractions are set as expected', function() {
        expect(element.extractions).to.deep.equal([{
          name: 'name1',
          data: [{
            id: 'id1',
            text: 'text1'
          }]
        }, {
          name: 'name2',
          data: [{
            classifications: {
              database: 'negative',
              type: 'type2',
              user: 'positive'
            },
            id: 'id2',
            text: 'text2'
          }]
        }]);
      });

      test('does show tag-extraction-buttons elements', function() {
        var buttons = Polymer.dom(element.root).querySelectorAll('tag-extraction-buttons');
        expect(buttons).to.exist;
        expect(buttons.length).to.equal(2);
        expect(buttons[0].classification).to.not.exist;
        expect(buttons[0].entityId).to.equal('abcd1234');
        expect(buttons[0].extractionKey).to.equal('id1');
        expect(buttons[0].tagManager).to.deep.equal(element.tagManager);
        expect(buttons[1].classification).to.deep.equal({
          database: 'negative',
          type: 'type2',
          user: 'positive'
        });
        expect(buttons[1].entityId).to.equal('abcd1234');
        expect(buttons[1].extractionKey).to.equal('id2');
        expect(buttons[1].tagManager).to.deep.equal(element.tagManager);
      });
    });
  </script>
</body>
</html>
